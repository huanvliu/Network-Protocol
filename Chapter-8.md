#### 互联网才是我向往的地方，我要出网关。

&nbsp;&nbsp;&nbsp;&nbsp;联机游戏打多了，突然发现对战平台上天梯更有意思,那怎么才能上网呢，我记得我们熬过了大一大二，学校总算允许宿舍开通网络了，每个寝室的网口分配了一个IP，这个IP就是校园网的IP，完全由网管部门控制。宿舍网的IP地址一般都是192.168.1.x,校园网的IP地址一般是10.10.x.x。这个时候，要上网一般有两个办法，第一种：让室长再买一张网卡，这样他的电脑就有两张网卡，一个网卡接校园网，另一个就接在寝室的交换机上。而且，新网卡的IP要按照学校网管部门分配的配置分，不然也上不了网。这种情况下，如果宿舍有人要上网，就需要一直开着室长的电脑。第二种：买个路由器，一般分为内网网口和外网网口，外网网口接校园网，内网接电脑，只要开着路由器就可以上网了。

&nbsp;&nbsp;&nbsp;&nbsp;两种方式其实是一个道理，第一种只是把电脑变成了路由器而已。而路由器，只是内部跑着程序，和电脑的功能是一样的。当室长可以上网后，接下来就是我们怎么上网了，这就需要配置网卡，当然DHCP是可以默认配置的。关键在于，除了IP的配置，还要配置一个叫Gateway的东西，这就是网关。你了解MAC头和IP头的细节么？一旦配置了IP地址和网关，往往就能够指定目标地址进行访问了。由于在跨网关访问的时候，牵扯到MAC地址和IP地址的变化，所以这里要详细描述一下MAC头和IP头的细节。

&nbsp;&nbsp;&nbsp;&nbsp;在MAC头中，先是目标MAC地址，然后是源MAC地址，然后有一个协议类型，用来说明是IP协议。IP头里面有版本号，目前主流的是IPv4，服务类型TOS在第3章讲IP地址的时候讲过，TTL是ICMP协议中的时间，另外还有8位长的标识协议，这里到了下一层的协议，也就是TCP或UDP。最重要的是目标IP和源IP。任何一台机器上，当要访问一个IP地址时，都会先判断这个目标IP地址和当前机器的IP地址是否在同一个网段，需要用到CIDR和子网掩码。

&nbsp;&nbsp;&nbsp;&nbsp;如果在同一个网段，例如，你要访问校园网的论坛，这就需要发往默认网关Gateway。网关的地址和源IP一定是在同一个网段的，往往不是第一个，就是第二个。例如192.168.1.1/24或192.168.1.2/24，这种都属于192.168.1.0/24网段，如何发往默认网关呢，网关和源机器在同一个网段，就像发往同一个LAN中的其它机器一样，网关拿到包以后，就需要看网关怎么做了，网关是往往是一个路由器，是一个三层转发的设备，啥叫三层设备？就是把MAC头和IP头都取下来，然后根据里面的内容决定把包发给哪里。在寝室中，路由器就是网关，一个路由器往往有多个网口，如果是一台服务器做这个事，则就有多个网卡，其中一个网卡和源IP就是同网段的。人们一般把网关都叫做路由器，其实不完全准确，网上有许多合适的比喻：路由器是一台设备，他有五个网口或网卡，相当于五只手，分别连着五个局域网。每只手的IP和局域网的网段都是相同的，每只手都是他握住的那个局域网的网关。任何一个发往其它局域网的包，都会到达其中一只手，取下MAC头和IP头，根据自己的路由算法，选择一只手，加上IP头和MAC头，然后扔出去。

&nbsp;&nbsp;&nbsp;&nbsp;什么是静态路由？问题来了，当包到达时，改选择哪一只手，IP头和MAC头加什么内容，哪些变，哪些不变呢？这个问题比较复杂，大致分为两类，一个是静态路由，一个是动态路由。我们先说说静态路由。静态路由其实就是在路由器上，配置一条一条的规则。这些规则包括，想访问论坛，从2号口出去，下一跳是IP2；想访问教学视频网站，从3号口出去，下一跳是IP3，这些规则保存在路由器里。每当要选择时，就按这些规则来。

&nbsp;&nbsp;&nbsp;&nbsp;IP头和MAC头又有哪些变化呢，之前说过，MAC地址是一个局域网内有效的地址，所以，MAC地址要过网关，肯定会改变，因为已经换了局域网。两者主要区别在于IP地址有没有改变，不改变IP地址的网关，我们称为转发网关，改变IP地址的我们称为NAT网关。假设服务器A要访问服务器B，目标192.168.4.101和我不在一个网段，肯定需要先发给网关，网关就是192.168.1.1。网关的MAC是多少呢，先通过ARP请求拿到网关的MAC，然后发包，包到达192.168.1.1这个网关，发现MAC一致，收包，然后开始思考往哪里转发。然后根据IP发现也不是自己这个局域网的，又发送到网关，通过ARP请求找到对应的MAC地址，直到找到对应的IP地址，也就是找到最后一跳，所谓的下一跳是某个IP要将这个IP地址转化为MAC放入MAC头。在整个过程中，IP头里的地址都是不变的。IP地址在三个局域网都可见，在三个局域网之间的网段都不会冲突。在三个网段之间传输包，IP头不会改变。

&nbsp;&nbsp;&nbsp;&nbsp;上面的过程中会遇到一个问题，每个局域网之间没有商量过，他们之间的IP很可能重复

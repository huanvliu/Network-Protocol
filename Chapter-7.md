#### 投石问路的侦察兵

&nbsp;&nbsp;&nbsp;&nbsp;无论在什么地方，我们经常会遇到网络不通的情况，也许机器明明在那，就是访问不了，我们就需要去查看究竟出现了什么问题。一般情况下，
你好想到使用ping，那么ping是如何工作的呢？

&nbsp;&nbsp;&nbsp;&nbsp;ping是基于ICMP协议工作的，全称互联网控制报文协议，那么我们就来了解一下，具体是怎么控制的。网络包在复杂的网络环境中传输时，常常会
遇到各种各样的问题。当遇到问题时，总不能“死个不明不白”，要知道了具体情况，我们才能做出调整，就像古代行军打仗，为将为帅者就需要哨兵，侦察兵等人肉的方式去
打探情况，根据情报调整战略。

&nbsp;&nbsp;&nbsp;&nbsp;ICMP就是一种这样的协议，主要封装在IP包里，因为传输指令的时候，肯定需要源地址和目标地址。它本身非常简单，因为是用于探听网络情况本身也适合携带大量信息。ICMP报文有多种类型，最常用的类型是主动请求为8，主动请求的应答为0。查询报文类型的时候，发起对应的查询报文类型，ping就是查询报文，一种主动请求，并且主动获得应答的ICMP协议。所以，ping的包也是符合ICMP协议的。只不过它在后面增加了自己的格式。对应ping的主动请求，进行网络抓包，称为ICMP ECHOREQUEST。同理主动请求的回复，称为ICMP ECHO REPLY。比起原生的ICMP，这里面多了两个字段，一个是**标识符**，用于区分功能，一个是**序号**，用于确定发送请求和响应的个数。在选项数据中，ping还会存放请求发送的时间值，用来计算往返时间，说明路程的长短。

&nbsp;&nbsp;&nbsp;&nbsp;当然，除了ping，还有另一种方式，差错报文，突然地异常情况，会主动报告，对应的ICMP就是差错报文类型，举几个ICMP报文的例子：终点不可达3，源抑制4，超时11，重定向5，这些具体是什么意思呢？
  - 终点不可达，主要分为网络不可达0（找不到地方），主机不可达1（找到地方，找不到人），协议不可达2（地方和人都找到了，口号对不上），端口不可达3（地方，人，口号都对上了，事情对不上），需要分片但设置了不分配的代码4（包太大，不拆分进不去，但又不允许拆。
  - 源抑制，让源站放慢发送速度，不要一直狂发不停
  - 超时，网速太慢，到了规定时间都还没到达终点
  - 路由重定向，重定向到一个地方
 差错报文的结果相对复杂一些，除了前面的IP，ICMP的前8字节不变，后面则跟上出错的包的IP头和IP正文的前8字节，查看这个IP头和前8字节，可以去定位具体出错原因。
 
&nbsp;&nbsp;&nbsp;&nbsp; 我们重点关注查询报文的使用，也就是ping的发送和接收。假设A的IP：192.168.1.1 B的IP：192.168.1.2，它们在同一个子网，当你在主机A上运行“ping”B的时候，会发生些什么呢？

&nbsp;&nbsp;&nbsp;&nbsp;ping执行的时候，源主机会构建一个ICMP请求数据包，ICMP数据包包含多个字段，最重要的有俩，第一个是**类型字段**，对应请求为8，另一个则是**序号字段**，主要用于区分连续ping发出的包。每发出一次请求，序号自动加1，为了计算往返时间RTT，会在报文插入发送时间。然后，由ICMP协议将这个数据包连通B的IP地址一起交个IP层。IP层将以B的IP地址作为目标地址，本机IP为原地址，加上一些其他控制信息，构建一个IP包。接下来，需要加入MAC头，如果在本节ARP映射表中查询出B栋对应MAC地址，则直接使用。如果没有，则需要发送ARP请求查询MAC地址；有了MAC后，由数据链路层构建数据帧，目的地址是IP层传过来的MAC地址，源是本机的MAC地址，加上一些其它信息，根据以太网介质访问规则，将他们传送出去。ping请求就发送完成了。

&nbsp;&nbsp;&nbsp;&nbsp;当B收到数据帧后，先检查MAC地址，再检查IP，都通过后，将有用的信息提取后叫给ICMP协议，主机B后构建一个ICMP应答包，类型字段为0，顺序号为接收到的请求包的顺序号，然后再发送出去给主机A。在规定的时间内，源主机没有接收到响应，说明主机不可达，如果收到后，用当前时刻减去发送的时间，就是时间延迟。当然这是在一个局域网中最简单的情况，如果跨网，还会涉及网关转发，路由转发等，对于ICMP协议，ICMP头是没有影响的，只是转发是IP，MAC会有些不同，后面会详细说到。
  
&nbsp;&nbsp;&nbsp;&nbsp;在自己可控的范围内，当遇到网络不通时，除了ping，我们还应该清楚整个网络拓扑，理论上讲，我们应该清楚从源主机到目标主机，要过哪些设备，我们逐个ping这些设备，就可以找到关键点，但是很多时候，有些设备是不允许ping的。ping不通不代表网络不通，这时还可以使用telnet等方式来确定。ping主要使用了8和0两种。

&nbsp;&nbsp;&nbsp;&nbsp;除了ping，还可以使用Traceroute，差错报文类型，Traceroute的第一个作用就是故意设置特殊的TTL，来追踪去往目的地沿途经过的路由器。Traceroute的参数指向一个IP，它会发出UDP的数据包，将TTL设置为1，也就说一旦遇到一个路由器或者一个关卡，就表示它牺牲了。如果中间路由不止一个，碰到第一个就牺牲了，于是，返回一个ICMP包，就是网络差错包，类型是超时。接下来将TTL设置为2，逐步增加，知道到达目标主机，这样就拿到了所有路由器的IP地址，当然，有的路由器不会回这个ICMP，这也是Traceroute一个公网的地址，看不到中间路由的原因。

&nbsp;&nbsp;&nbsp;&nbsp;怎么知道UDP有没有到达目的主机呢？Traceroute程序会发送一份UDP数据报给目的主机，会选择一个不可能的值作为UDP端口号，当到达时，目的主机就会产生一份端口不可达的ICMP报文，如果数据报没到，则可能是超时。

&nbsp;&nbsp;&nbsp;&nbsp;Traceroute还有一个作用就是故意设置不分配=片，来确定路径的MTU。每次收到分片错误的时候，就递减分组的长度，直到到达目标主机，也就确定了路径的MTU。

#### DHCP与PEX:IP怎么来的，又是怎么没的

&npsp;&npsp;&npsp;&npsp; 通过上一章我们了解到，如果需要与其它机器通信，我们就需要一个通信地址，分配给对应的网卡。那么，如何将IP分配给网卡呢？学完这一张
你就可以使用ifcongfig 或 ip addr给机器手动分配一个地址了。先看配置命令：
```
sudo ifconfig eth1 10.0.0.1/24
sudo ifconfig eth1 up

如果使用iproute2

sudo ip addr 10.0.0.1/24 dev
sudo ip link set up eth1

```

配置的命令其实很简单，但是要注意的是分配正确的IP才能实现互通。例如，旁边的机器都是：192.168.1.x 你自己非要配置：16.158.23.6 根据上一张讲到的包出去的过程
我们可以知道，他会找不到这个IP，那么就收不到包，就实现不了互通。第二节我们说过：网络包一定是完整的，可以有下层没上层，但不能相反。因为这两个IP的网段是不一样
样的，不一样则不会发送ARP请求，那么就不会加MAC头，这就形成跨网段调用，就不会把包发送到网络中，而是企图发送到网关，虽然网关能找到，能确定目标IP就是自己，但
是却没有填写MAC地址，所以网关拒收。如果没有网关，包根本发布出去，因为它要发送给网关，但又没有网关，这就冲突了。所以手动配置的时候，一定要配置合适的IP，不同
的系统配置文件的格式不同，但是无非就是CIDR，子网掩码，广播地址和网关地址。

&npsp;&npsp;&npsp;&npsp; 动态主机配置协议（DHCP），配置ip的门道还是挺多的，ip配置以后一般不变，这是服务端机器还好，一直在一个网段内。但客户端的机器经常
在不同的环境，连不同的wifi，那不可能去一个环境就配置一次IP吧，那估计要疯了。所以，我们需要一个自动配置的协议，就是DHCP。有了这个协议，网管就非常轻松了，
他只需要配置一段共享的IP，每台机器都通过DHCP协议去共享IP中申请IP地址，然后自动配置，走了后又还回去，供其他机器使用。打个比方：数据中心的服务器，ip一旦配
置，基本不会变，就像自己买了房，自己装修。DHCP就像租房，不用装修，都帮你配好，租完后把房退了就行。

&npsp;&npsp;&npsp;&npsp;那么DHCP的具体工作方式是怎样的呢？当一台新机器加入一个网络后，什么都没有，也什么都不知道，只有自己的MAC地址，这时，通信基本靠
吼，“我来了，有人嘛”，这就是DHCP Discover。新来的机器使用0.0.0.0 发送一个广播包，目标地址为255.255.255.255。广播包封装了UDP，UDP封装了BOOTP，DHCP就是
BOOTP的增强版，如果去抓包，你可能看到包里面的协议还是BOOTP协议。在广播包里：我是Boot request,我的MAC地址是XXXX，能否租一个IP给我，我要上网。基本包括：
MAC头，IP头(新人使用0.0.0.0)，UDP头，BOOTP头，content(租IP)。如果网络中有DHCP server，他就会知道来了一个新人，需要给他一个IP，这里MAC地址的唯一性就非常
重要了，因为DHCP server是通过MAC地址去判断是否是新人的。分配的过程称为DHCP Offer，同时，DHCP server会保存提供的IP给哪个MAC的信息，保证不会重复分配IP。
DHCP server发送的广播包：MAC头，IP头，UDP头，BOOTP头（boot reply），包括分配的IP，子网掩码等各种信息。如果有多个DHCP server，很可能同时收到多个广播包，
新机器会选择其中一个，一般是先到达的那个，然后想网络发送一个DHCP request广播包，包括MAC，租用的IP，是那个DHCP server提供的IP，这样其余的DHCP server就
撤销分配，选中的就记录此IP已经分配，但这个过程中，IP租用还没得到DHCP server 的二次认可，所以会继续使用0.0.0.0，当server 收到后，回复一个ACK，表示接受客户
的选择，最终达成一致，同时广播一下，让网段的机器都知道。
